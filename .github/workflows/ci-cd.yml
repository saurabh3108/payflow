# ============================================
# PayFlow CI/CD Pipeline
# ============================================
# Triggers:
#   - Push to main branch ‚Üí Build, Push to GHCR, Deploy to AWS (prod)
#   - Push to develop branch ‚Üí Build, Push to GHCR, Deploy to Dev
#   - Pull Request to main ‚Üí Build only (validation)
# ============================================
# Environments:
#   - develop branch ‚Üí Development environment
#   - main branch ‚Üí Production environment (AWS)
# ============================================

name: PayFlow CI/CD

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  # Manual trigger for deployment
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/payflow

jobs:
  # ============================================
  # STAGE 1: BUILD & TEST
  # ============================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images (validation)
        run: |
          docker compose build --no-cache

  # ============================================
  # STAGE 2: PUSH TO GHCR
  # ============================================
  push:
    name: Push to GHCR
    runs-on: ubuntu-latest
    needs: build
    # Only push on main or develop branch (not on PRs)
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.TAG }}
      sha_short: ${{ steps.meta.outputs.SHA_SHORT }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        run: |
          # Determine tag based on branch
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "TAG=latest" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "TAG=develop" >> $GITHUB_OUTPUT
          else
            echo "TAG=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi
          echo "SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Build and Push API Gateway
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/api-gateway/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-api-gateway:${{ steps.meta.outputs.TAG }}
            ${{ env.IMAGE_PREFIX }}-api-gateway:${{ steps.meta.outputs.SHA_SHORT }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Account Service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/account-service/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-account-service:${{ steps.meta.outputs.TAG }}
            ${{ env.IMAGE_PREFIX }}-account-service:${{ steps.meta.outputs.SHA_SHORT }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Transaction Service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/transaction-service/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-transaction-service:${{ steps.meta.outputs.TAG }}
            ${{ env.IMAGE_PREFIX }}-transaction-service:${{ steps.meta.outputs.SHA_SHORT }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Notification Service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/notification-service/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-notification-service:${{ steps.meta.outputs.TAG }}
            ${{ env.IMAGE_PREFIX }}-notification-service:${{ steps.meta.outputs.SHA_SHORT }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: frontend/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-frontend:${{ steps.meta.outputs.TAG }}
            ${{ env.IMAGE_PREFIX }}-frontend:${{ steps.meta.outputs.SHA_SHORT }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          echo "## üê≥ Images Pushed to GHCR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Image |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| API Gateway | \`${{ env.IMAGE_PREFIX }}-api-gateway:${{ steps.meta.outputs.TAG }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Account Service | \`${{ env.IMAGE_PREFIX }}-account-service:${{ steps.meta.outputs.TAG }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Transaction Service | \`${{ env.IMAGE_PREFIX }}-transaction-service:${{ steps.meta.outputs.TAG }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Notification Service | \`${{ env.IMAGE_PREFIX }}-notification-service:${{ steps.meta.outputs.TAG }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | \`${{ env.IMAGE_PREFIX }}-frontend:${{ steps.meta.outputs.TAG }}\` |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 3: DEPLOY TO DEVELOPMENT (Local K8s)
  # ============================================
  # Note: For local Docker Desktop K8s, this outputs instructions
  # since GitHub Actions cannot reach local environments.
  # Use self-hosted runner for automatic local deployment.
  # ============================================
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: push
    if: github.ref == 'refs/heads/develop' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'development'))
    environment: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Deployment Instructions
        run: |
          echo "## üöÄ Development Deployment Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Images have been pushed to GHCR with tag: **${{ needs.push.outputs.image_tag }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Deploy to Local Kubernetes (Docker Desktop)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run these commands on your local machine:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`powershell" >> $GITHUB_STEP_SUMMARY
          echo "# Navigate to project directory" >> $GITHUB_STEP_SUMMARY
          echo "cd payflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Pull latest code" >> $GITHUB_STEP_SUMMARY
          echo "git pull origin develop" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Apply k8s manifests (if new services added)" >> $GITHUB_STEP_SUMMARY
          echo "kubectl apply -f k8s/namespace.yaml" >> $GITHUB_STEP_SUMMARY
          echo "kubectl apply -f k8s/configmaps/" >> $GITHUB_STEP_SUMMARY
          echo "kubectl apply -f k8s/secrets/" >> $GITHUB_STEP_SUMMARY
          echo "kubectl apply -f k8s/deployments/" >> $GITHUB_STEP_SUMMARY
          echo "kubectl apply -f k8s/services/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Rollout restart to pull new images" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout restart deployment -n payflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Verify rollout" >> $GITHUB_STEP_SUMMARY
          echo "kubectl rollout status deployment -n payflow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check all pods" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n payflow" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîÑ Or use the deployment script:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`powershell" >> $GITHUB_STEP_SUMMARY
          echo "./deploy-k8s.ps1 -Environment dev" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 4: DEPLOY TO PRODUCTION (AWS)
  # ============================================
  # This stage deploys to AWS EC2 via SSH
  # Required secrets:
  #   - AWS_HOST: EC2 public IP or hostname
  #   - AWS_SSH_KEY: Private SSH key for EC2
  #   - AWS_USER: SSH username (default: ubuntu)
  # ============================================
  deploy-prod:
    name: Deploy to Production (AWS)
    runs-on: ubuntu-latest
    needs: push
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'))
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_SSH_KEY }}" > ~/.ssh/payflow-key.pem
          chmod 600 ~/.ssh/payflow-key.pem
          ssh-keyscan -H ${{ secrets.AWS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to AWS EC2
        env:
          AWS_HOST: ${{ secrets.AWS_HOST }}
          AWS_USER: ${{ secrets.AWS_USER || 'ubuntu' }}
          IMAGE_TAG: ${{ needs.push.outputs.image_tag }}
        run: |
          # Copy k8s manifests to server
          scp -i ~/.ssh/payflow-key.pem -r k8s/ $AWS_USER@$AWS_HOST:~/payflow/
          
          # Execute deployment commands on AWS
          ssh -i ~/.ssh/payflow-key.pem $AWS_USER@$AWS_HOST << 'DEPLOY_SCRIPT'
            set -e
            echo "üöÄ Starting deployment to production..."
            
            cd ~/payflow
            
            # Pull latest code
            git pull origin main || true
            
            # Login to GHCR (using saved credentials)
            echo "üì¶ Logging into GHCR..."
            
            # Apply all k8s manifests
            echo "üìã Applying Kubernetes manifests..."
            kubectl apply -f k8s/namespace.yaml
            kubectl apply -f k8s/configmaps/
            kubectl apply -f k8s/secrets/
            kubectl apply -f k8s/deployments/
            kubectl apply -f k8s/services/
            
            # Rollout restart all deployments to pull new images
            echo "üîÑ Rolling out new images..."
            kubectl rollout restart deployment/frontend -n payflow
            kubectl rollout restart deployment/api-gateway -n payflow
            kubectl rollout restart deployment/account-service -n payflow
            kubectl rollout restart deployment/transaction-service -n payflow
            kubectl rollout restart deployment/notification-service -n payflow
            
            # Wait for rollouts to complete
            echo "‚è≥ Waiting for rollouts to complete..."
            kubectl rollout status deployment/frontend -n payflow --timeout=120s
            kubectl rollout status deployment/api-gateway -n payflow --timeout=120s
            kubectl rollout status deployment/account-service -n payflow --timeout=120s
            kubectl rollout status deployment/transaction-service -n payflow --timeout=120s
            kubectl rollout status deployment/notification-service -n payflow --timeout=120s
            
            # Show final status
            echo "‚úÖ Deployment complete! Pod status:"
            kubectl get pods -n payflow
            
          DEPLOY_SCRIPT

      - name: Deployment Summary
        run: |
          echo "## üéâ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | **Production (AWS)** |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`${{ needs.push.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ needs.push.outputs.sha_short }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed At | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Access URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: http://${{ secrets.AWS_HOST }}/" >> $GITHUB_STEP_SUMMARY
          echo "- API Gateway: http://${{ secrets.AWS_HOST }}:8080/" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup SSH Key
        if: always()
        run: |
          rm -f ~/.ssh/payflow-key.pem

  # ============================================
  # NOTIFICATION JOB (Optional)
  # ============================================
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [push, deploy-prod]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
      - name: Check deployment status
        run: |
          if [ "${{ needs.deploy-prod.result }}" == "success" ]; then
            echo "‚úÖ Deployment succeeded!"
          else
            echo "‚ùå Deployment failed or was skipped"
            exit 1
          fi
