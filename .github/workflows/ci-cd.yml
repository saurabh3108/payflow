# ============================================
# PayFlow CI/CD Pipeline
# ============================================
# Triggers:
#   - Push to main branch â†’ Build, Push to GHCR, Deploy to AWS (prod)
#   - Push to develop branch â†’ Build, Push to GHCR, Deploy to Local K8s
#   - Pull Request to main â†’ Build only (validation)
# ============================================
# Features:
#   - Selective builds: Only builds services with changes
#   - Auto-deploy: Uses self-hosted runner for local deployment
#   - Environment switching: dev (local) vs prod (AWS)
# ============================================

name: PayFlow CI/CD

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production
      force_build_all:
        description: 'Force build all services'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/payflow

jobs:
  # ============================================
  # STAGE 0: DETECT CHANGES
  # ============================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      api-gateway: ${{ steps.filter.outputs.api-gateway }}
      account-service: ${{ steps.filter.outputs.account-service }}
      transaction-service: ${{ steps.filter.outputs.transaction-service }}
      notification-service: ${{ steps.filter.outputs.notification-service }}
      frontend: ${{ steps.filter.outputs.frontend }}
      k8s: ${{ steps.filter.outputs.k8s }}
      any_service: ${{ steps.check.outputs.any_service }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api-gateway:
              - 'services/api-gateway/**'
              - 'pom.xml'
            account-service:
              - 'services/account-service/**'
              - 'pom.xml'
            transaction-service:
              - 'services/transaction-service/**'
              - 'pom.xml'
            notification-service:
              - 'services/notification-service/**'
              - 'pom.xml'
            frontend:
              - 'frontend/**'
            k8s:
              - 'k8s/**'

      - name: Check if any service changed
        id: check
        run: |
          if [ "${{ steps.filter.outputs.api-gateway }}" == "true" ] || \
             [ "${{ steps.filter.outputs.account-service }}" == "true" ] || \
             [ "${{ steps.filter.outputs.transaction-service }}" == "true" ] || \
             [ "${{ steps.filter.outputs.notification-service }}" == "true" ] || \
             [ "${{ steps.filter.outputs.frontend }}" == "true" ] || \
             [ "${{ github.event.inputs.force_build_all }}" == "true" ]; then
            echo "any_service=true" >> $GITHUB_OUTPUT
          else
            echo "any_service=false" >> $GITHUB_OUTPUT
          fi

      - name: Summary of changes
        run: |
          echo "## ðŸ” Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| API Gateway | ${{ steps.filter.outputs.api-gateway == 'true' && 'âœ… Yes' || 'â­ï¸ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Account Service | ${{ steps.filter.outputs.account-service == 'true' && 'âœ… Yes' || 'â­ï¸ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Transaction Service | ${{ steps.filter.outputs.transaction-service == 'true' && 'âœ… Yes' || 'â­ï¸ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Notification Service | ${{ steps.filter.outputs.notification-service == 'true' && 'âœ… Yes' || 'â­ï¸ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.filter.outputs.frontend == 'true' && 'âœ… Yes' || 'â­ï¸ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| K8s Manifests | ${{ steps.filter.outputs.k8s == 'true' && 'âœ… Yes' || 'â­ï¸ No' }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 1: BUILD & TEST (Selective)
  # ============================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.any_service == 'true' || github.event.inputs.force_build_all == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        if: needs.changes.outputs.api-gateway == 'true' || needs.changes.outputs.account-service == 'true' || needs.changes.outputs.transaction-service == 'true' || needs.changes.outputs.notification-service == 'true' || github.event.inputs.force_build_all == 'true'
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build API Gateway
        if: needs.changes.outputs.api-gateway == 'true' || github.event.inputs.force_build_all == 'true'
        run: |
          echo "ðŸ”¨ Building API Gateway..."
          mvn clean package -DskipTests -pl services/api-gateway -am

      - name: Build Account Service
        if: needs.changes.outputs.account-service == 'true' || github.event.inputs.force_build_all == 'true'
        run: |
          echo "ðŸ”¨ Building Account Service..."
          mvn clean package -DskipTests -pl services/account-service -am

      - name: Build Transaction Service
        if: needs.changes.outputs.transaction-service == 'true' || github.event.inputs.force_build_all == 'true'
        run: |
          echo "ðŸ”¨ Building Transaction Service..."
          mvn clean package -DskipTests -pl services/transaction-service -am

      - name: Build Notification Service
        if: needs.changes.outputs.notification-service == 'true' || github.event.inputs.force_build_all == 'true'
        run: |
          echo "ðŸ”¨ Building Notification Service..."
          mvn clean package -DskipTests -pl services/notification-service -am

      - name: Set up Node.js for Frontend
        if: needs.changes.outputs.frontend == 'true' || github.event.inputs.force_build_all == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build Frontend
        if: needs.changes.outputs.frontend == 'true' || github.event.inputs.force_build_all == 'true'
        run: |
          echo "ðŸ”¨ Building Frontend..."
          cd frontend
          npm ci
          npm run build

      - name: Build Summary
        run: |
          echo "## ðŸ”¨ Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| API Gateway | ${{ (needs.changes.outputs.api-gateway == 'true' || github.event.inputs.force_build_all == 'true') && 'âœ… Built' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Account Service | ${{ (needs.changes.outputs.account-service == 'true' || github.event.inputs.force_build_all == 'true') && 'âœ… Built' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Transaction Service | ${{ (needs.changes.outputs.transaction-service == 'true' || github.event.inputs.force_build_all == 'true') && 'âœ… Built' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Notification Service | ${{ (needs.changes.outputs.notification-service == 'true' || github.event.inputs.force_build_all == 'true') && 'âœ… Built' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ (needs.changes.outputs.frontend == 'true' || github.event.inputs.force_build_all == 'true') && 'âœ… Built' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 2: PUSH TO GHCR (Selective)
  # ============================================
  push:
    name: Push to GHCR
    runs-on: ubuntu-latest
    needs: [changes, build]
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && needs.changes.outputs.any_service == 'true'
    
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.TAG }}
      sha_short: ${{ steps.meta.outputs.SHA_SHORT }}
      pushed_services: ${{ steps.pushed.outputs.services }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build all Java services
        run: mvn clean package -DskipTests

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "TAG=latest" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "TAG=develop" >> $GITHUB_OUTPUT
          else
            echo "TAG=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi
          echo "SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Build and Push API Gateway
        if: needs.changes.outputs.api-gateway == 'true' || github.event.inputs.force_build_all == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/api-gateway/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-api-gateway:${{ steps.meta.outputs.TAG }}
            ${{ env.IMAGE_PREFIX }}-api-gateway:${{ steps.meta.outputs.SHA_SHORT }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Account Service
        if: needs.changes.outputs.account-service == 'true' || github.event.inputs.force_build_all == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/account-service/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-account-service:${{ steps.meta.outputs.TAG }}
            ${{ env.IMAGE_PREFIX }}-account-service:${{ steps.meta.outputs.SHA_SHORT }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Transaction Service
        if: needs.changes.outputs.transaction-service == 'true' || github.event.inputs.force_build_all == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/transaction-service/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-transaction-service:${{ steps.meta.outputs.TAG }}
            ${{ env.IMAGE_PREFIX }}-transaction-service:${{ steps.meta.outputs.SHA_SHORT }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Notification Service
        if: needs.changes.outputs.notification-service == 'true' || github.event.inputs.force_build_all == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/notification-service/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-notification-service:${{ steps.meta.outputs.TAG }}
            ${{ env.IMAGE_PREFIX }}-notification-service:${{ steps.meta.outputs.SHA_SHORT }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and Push Frontend
        if: needs.changes.outputs.frontend == 'true' || github.event.inputs.force_build_all == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: frontend/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}-frontend:${{ steps.meta.outputs.TAG }}
            ${{ env.IMAGE_PREFIX }}-frontend:${{ steps.meta.outputs.SHA_SHORT }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Track pushed services
        id: pushed
        run: |
          SERVICES=""
          if [ "${{ needs.changes.outputs.api-gateway }}" == "true" ] || [ "${{ github.event.inputs.force_build_all }}" == "true" ]; then
            SERVICES="${SERVICES}api-gateway,"
          fi
          if [ "${{ needs.changes.outputs.account-service }}" == "true" ] || [ "${{ github.event.inputs.force_build_all }}" == "true" ]; then
            SERVICES="${SERVICES}account-service,"
          fi
          if [ "${{ needs.changes.outputs.transaction-service }}" == "true" ] || [ "${{ github.event.inputs.force_build_all }}" == "true" ]; then
            SERVICES="${SERVICES}transaction-service,"
          fi
          if [ "${{ needs.changes.outputs.notification-service }}" == "true" ] || [ "${{ github.event.inputs.force_build_all }}" == "true" ]; then
            SERVICES="${SERVICES}notification-service,"
          fi
          if [ "${{ needs.changes.outputs.frontend }}" == "true" ] || [ "${{ github.event.inputs.force_build_all }}" == "true" ]; then
            SERVICES="${SERVICES}frontend,"
          fi
          echo "services=${SERVICES%,}" >> $GITHUB_OUTPUT

      - name: Push Summary
        run: |
          echo "## ðŸ³ Images Pushed to GHCR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ steps.meta.outputs.TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | Image |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| API Gateway | ${{ (needs.changes.outputs.api-gateway == 'true' || github.event.inputs.force_build_all == 'true') && 'âœ… Pushed' || 'â­ï¸ Skipped' }} | ${{ (needs.changes.outputs.api-gateway == 'true' || github.event.inputs.force_build_all == 'true') && format('{0}-api-gateway:{1}', env.IMAGE_PREFIX, steps.meta.outputs.TAG) || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Account Service | ${{ (needs.changes.outputs.account-service == 'true' || github.event.inputs.force_build_all == 'true') && 'âœ… Pushed' || 'â­ï¸ Skipped' }} | ${{ (needs.changes.outputs.account-service == 'true' || github.event.inputs.force_build_all == 'true') && format('{0}-account-service:{1}', env.IMAGE_PREFIX, steps.meta.outputs.TAG) || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Transaction Service | ${{ (needs.changes.outputs.transaction-service == 'true' || github.event.inputs.force_build_all == 'true') && 'âœ… Pushed' || 'â­ï¸ Skipped' }} | ${{ (needs.changes.outputs.transaction-service == 'true' || github.event.inputs.force_build_all == 'true') && format('{0}-transaction-service:{1}', env.IMAGE_PREFIX, steps.meta.outputs.TAG) || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Notification Service | ${{ (needs.changes.outputs.notification-service == 'true' || github.event.inputs.force_build_all == 'true') && 'âœ… Pushed' || 'â­ï¸ Skipped' }} | ${{ (needs.changes.outputs.notification-service == 'true' || github.event.inputs.force_build_all == 'true') && format('{0}-notification-service:{1}', env.IMAGE_PREFIX, steps.meta.outputs.TAG) || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ (needs.changes.outputs.frontend == 'true' || github.event.inputs.force_build_all == 'true') && 'âœ… Pushed' || 'â­ï¸ Skipped' }} | ${{ (needs.changes.outputs.frontend == 'true' || github.event.inputs.force_build_all == 'true') && format('{0}-frontend:{1}', env.IMAGE_PREFIX, steps.meta.outputs.TAG) || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 3: DEPLOY TO LOCAL K8s (Development)
  # ============================================
  # Generates deployment commands for local K8s
  # After pipeline completes, run the provided commands locally
  # ============================================
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [changes, push]
    if: github.ref == 'refs/heads/develop' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'development'))
    environment: development

    steps:
      - name: Generate Deployment Commands
        run: |
          echo "## ðŸš€ Development Deployment Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Images pushed to GHCR with tag:** \`${{ needs.push.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Services Updated:" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ needs.push.outputs.pushed_services }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Quick Deploy (Copy & Run in PowerShell):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`powershell" >> $GITHUB_STEP_SUMMARY
          echo "# Navigate to project and pull latest" >> $GITHUB_STEP_SUMMARY
          echo "cd payflow; git pull origin develop" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Restart updated services to pull new images" >> $GITHUB_STEP_SUMMARY
          SERVICES="${{ needs.push.outputs.pushed_services }}"
          if [ -n "$SERVICES" ]; then
            IFS=',' read -ra SERVICE_ARRAY <<< "$SERVICES"
            for service in "${SERVICE_ARRAY[@]}"; do
              echo "kubectl rollout restart deployment/$service -n payflow" >> $GITHUB_STEP_SUMMARY
            done
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Verify rollout" >> $GITHUB_STEP_SUMMARY
          echo "kubectl get pods -n payflow" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“œ Or use deployment script:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`powershell" >> $GITHUB_STEP_SUMMARY
          echo "./deploy-k8s.ps1 -RolloutOnly" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 4: DEPLOY TO PRODUCTION (AWS)
  # ============================================
  deploy-prod:
    name: Deploy to Production (AWS)
    runs-on: ubuntu-latest
    needs: [changes, push]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'))
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AWS_SSH_KEY }}" > ~/.ssh/payflow-key.pem
          chmod 600 ~/.ssh/payflow-key.pem
          ssh-keyscan -H ${{ secrets.AWS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to AWS EC2
        env:
          AWS_HOST: ${{ secrets.AWS_HOST }}
          AWS_USER: ${{ secrets.AWS_USER || 'ubuntu' }}
          PUSHED_SERVICES: ${{ needs.push.outputs.pushed_services }}
        run: |
          # Copy k8s manifests to server
          scp -i ~/.ssh/payflow-key.pem -r k8s/ $AWS_USER@$AWS_HOST:~/payflow/
          
          # Execute deployment commands on AWS
          ssh -i ~/.ssh/payflow-key.pem $AWS_USER@$AWS_HOST << DEPLOY_SCRIPT
            set -e
            echo "ðŸš€ Starting deployment to production..."
            
            cd ~/payflow
            
            # Pull latest code
            git pull origin main || true
            
            # Apply all k8s manifests
            echo "ðŸ“‹ Applying Kubernetes manifests..."
            kubectl apply -f k8s/namespace.yaml
            kubectl apply -f k8s/configmaps/
            kubectl apply -f k8s/secrets/
            kubectl apply -f k8s/deployments/
            kubectl apply -f k8s/services/
            
            # Rollout only changed services
            echo "ðŸ”„ Rolling out updated services..."
            SERVICES="$PUSHED_SERVICES"
            if [ -n "\$SERVICES" ]; then
              IFS=',' read -ra SERVICE_ARRAY <<< "\$SERVICES"
              for service in "\${SERVICE_ARRAY[@]}"; do
                echo "Restarting \$service..."
                kubectl rollout restart deployment/\$service -n payflow || true
              done
              
              # Wait for rollouts
              echo "â³ Waiting for rollouts..."
              for service in "\${SERVICE_ARRAY[@]}"; do
                kubectl rollout status deployment/\$service -n payflow --timeout=120s || true
              done
            fi
            
            echo "âœ… Deployment complete!"
            kubectl get pods -n payflow
          DEPLOY_SCRIPT

      - name: Deployment Summary
        run: |
          echo "## ðŸŽ‰ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | **Production (AWS)** |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`${{ needs.push.outputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Services Deployed | \`${{ needs.push.outputs.pushed_services }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed At | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/payflow-key.pem
